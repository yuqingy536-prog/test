import React, { useState, useEffect } from 'react';
import { 
  Shield, Search, Calculator, Building, 
  ChevronRight, Phone, Menu, X, CheckCircle, 
  FileText, TrendingUp, Users, Lock, ShoppingCart, 
  Monitor, BarChart3, Briefcase, Gavel, ArrowRight, Server,
  MapPin, Clock, Wrench, Star, DollarSign, Award, Heart,
  AlertCircle, Camera, PenTool, UserCheck, Zap, Smartphone,
  RefreshCcw, Minus, Plus, Printer, Info, Ruler, 
  Flame, BellRing, DoorOpen, CheckSquare, Square, CheckCircle2,
  Instagram, Youtube, Facebook
} from 'lucide-react';

// --- Brand Logo Component (Updated) ---
const CarbonLogo = ({ className }) => (
  <svg viewBox="0 0 200 200" className={className} xmlns="http://www.w3.org/2000/svg" fill="none">
    <defs>
      <linearGradient id="carbonGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#F97316" /> {/* Orange-500 */}
        <stop offset="100%" stopColor="#DB2777" /> {/* Pink-600 */}
      </linearGradient>
    </defs>
    {/* Hexagon Container (Carbon Structure) */}
    <path 
      d="M100 20 L170 60 V140 L100 180 L30 140 V60 L100 20Z" 
      stroke="url(#carbonGradient)" 
      strokeWidth="12" 
      strokeLinejoin="round" 
      fill="white"
      fillOpacity="0.05"
    />
    {/* Inner 'C' / Shield Shape */}
    <path 
      d="M140 70 C140 70 100 45 100 45 C100 45 55 70 55 100 C55 130 100 155 100 155" 
      stroke="url(#carbonGradient)" 
      strokeWidth="14" 
      strokeLinecap="round" 
    />
    {/* Tech Node / Alert Dot - Updated to GREEN (#22c55e) representing Safety/Go */}
    <circle cx="140" cy="130" r="12" fill="#22c55e" />
  </svg>
);

// --- Fire Safety Quote Calculator Component ---
const FireSafetyQuoteCalculator = () => {
  // --- 狀態管理 ---
  const [selectedCategory, setSelectedCategory] = useState(''); // 甲乙丙丁戊
  const [selectedUsage, setSelectedUsage] = useState(''); // 詳細用途
  const [area, setArea] = useState(''); // 平方公尺
  const [floors, setFloors] = useState(''); // 樓層數量
  const [selectedSystems, setSelectedSystems] = useState([]); // 新增：已選擇的系統
  const [quantities, setQuantities] = useState({});
  const [includeRecheck, setIncludeRecheck] = useState(false);
  const [totalPrice, setTotalPrice] = useState({ filing: 0, inspection: 0, other: 0, total: 0 });

  // --- 參數設定 ---
  const BASE_AREA_LIMIT = 3000; // 基本費涵蓋面積 (3000 m^2)
  const AREA_STEP = 500; // 每 500 m^2 為一個級距
  const PRICE_PER_STEP = 1000; // 每個級距加收 1000 元
  const RECHECK_FEE = 3000; 

  // --- 1. 場所分類資料 ---
  const placeStandards = [
    {
      id: 'A',
      categoryName: '甲類場所',
      basePrice: 6000,
      description: '人多、高風險 (KTV/餐廳/飯店)',
      items: [
        '電影院、戲院、歌廳、演藝場、歌舞廳',
        '夜總會、俱樂部、理容院、三溫暖',
        'KTV、MTV、視聽歌唱場所',
        '保齡球館、撞球場、集會堂',
        '觀光飯店、飯店、旅館、招待所',
        '商場、市場、百貨商場、超級市場',
        '餐廳、飲食店、咖啡廳、飲茶',
        '醫院、療養院、榮譽國民之家',
        '護理之家、產後護理機構、長照機構',
        '幼稚園、托兒所 (樓地板面積500㎡以上)'
      ]
    },
    {
      id: 'B',
      categoryName: '乙類場所',
      basePrice: 6000,
      description: '辦公、學校、補習班',
      items: [
        '車站、候船室、航空站',
        '學校、補習班、訓練班',
        '圖書館、博物館、美術館',
        '寺廟、宗祠、教堂、靈骨塔',
        '辦公室、證券交易所、金融機構',
        '集合住宅、寄宿舍',
        '體育館、活動中心',
        '幼稚園、托兒所 (樓地板面積未滿500㎡)'
      ]
    },
    {
      id: 'C',
      categoryName: '丙類場所',
      basePrice: 6000,
      description: '工業、停車場',
      items: [
        '電信機器室',
        '汽車修護廠、飛機修理廠',
        '室內停車場、建築物依法附設之停車空間'
      ]
    },
    {
      id: 'D',
      categoryName: '丁類場所',
      basePrice: 6000,
      description: '工廠、倉庫',
      items: [
        '高度危險工作場所',
        '中度危險工作場所',
        '低度危險工作場所 (一般工廠)',
        '倉庫'
      ]
    },
    {
      id: 'E',
      categoryName: '戊類場所',
      basePrice: 6000,
      description: '住商混合',
      items: [
        '複合用途建築物 (住商混合等)',
        '地下建築物'
      ]
    }
  ];

  // --- 2. 系統清單 (供客戶勾選) ---
  const systemOptions = [
    { id: 'fire_extinguisher', name: '滅火器設備' },
    { id: 'indoor_hydrant', name: '室內消防栓設備' },
    { id: 'outdoor_hydrant', name: '室外消防栓設備' },
    { id: 'sprinkler', name: '自動撒水設備' },
    { id: 'water_mist', name: '水霧滅火設備' },
    { id: 'foam', name: '泡沫滅火設備' },
    { id: 'inert_gas', name: '惰性氣體滅火設備' },
    { id: 'dry_powder', name: '乾粉滅火設備' },
    { id: 'halon', name: '海龍滅火設備' },
    { id: 'simple_auto', name: '簡易自動滅火設備' },
    { id: 'halide', name: '鹵化烴滅火設備' },
    { id: 'alarm', name: '火警自動警報設備' },
    { id: 'gas_leak', name: '瓦斯漏氣火警自動警報設備' },
    { id: 'broadcast', name: '緊急廣播設備' },
    { id: '119_notify', name: '一一九火災通報裝置' },
    { id: 'sign', name: '標示設備' },
    { id: 'escape', name: '避難器具' },
    { id: 'emergency_light', name: '緊急照明設備' },
    { id: 'water_connection', name: '連結送水管' },
    { id: 'water_pool', name: '消防專用蓄水池' },
    { id: 'smoke_exhaust', name: '排煙設備' },
    { id: 'radio', name: '無線電通信輔助設備' },
    { id: 'emergency_socket', name: '緊急電源插座' },
    { id: 'emergency_power', name: '緊急電源設備' },
    { id: 'cooling_sprinkler', name: '冷卻撒水設備' },
    { id: 'water_cannon', name: '射水設備' },
    { id: 'heat_wire', name: '耐燃耐熱配線' },
    { id: 'monitor_control', name: '防災監控系統綜合操作裝置' }
  ];

  // --- 3. 設備計價清單 (包含與系統的關聯) ---
  const equipmentList = [
    // 1. 滅火設備
    { id: 'extinguisher', name: '滅火器', unit: '支', price: 10, category: '滅火設備', icon: <Flame size={18} />, relatedSystems: ['fire_extinguisher'] },
    { id: 'hydrant_indoor', name: '室內消防栓', unit: '箱', price: 500, category: '滅火設備', icon: <Flame size={18} />, relatedSystems: ['indoor_hydrant'] },
    { id: 'hydrant_outdoor', name: '室外消防栓', unit: '支', price: 500, category: '滅火設備', icon: <Flame size={18} />, relatedSystems: ['outdoor_hydrant'] },
    { id: 'sprinkler_head', name: '自動撒水頭 (抽測)', unit: '顆', price: 50, category: '滅火設備', icon: <Flame size={18} />, relatedSystems: ['sprinkler', 'water_mist', 'simple_auto', 'cooling_sprinkler'] }, 
    { id: 'sprinkler_valve', name: '自動警報逆止閥', unit: '組', price: 300, category: '滅火設備', icon: <Flame size={18} />, relatedSystems: ['sprinkler', 'water_mist', 'cooling_sprinkler'] },
    { id: 'foam_switch', name: '泡沫手動啟動開關', unit: '組', price: 50, category: '滅火設備', icon: <Flame size={18} />, relatedSystems: ['foam'] },
    
    // 2. 警報設備
    { id: 'alarm_panel', name: '火警受信總機', unit: '台', price: 3000, category: '警報設備', icon: <BellRing size={18} />, relatedSystems: ['alarm', 'gas_leak', 'monitor_control'] },
    { id: 'alarm_detector', name: '火警探測器', unit: '顆', price: 20, category: '警報設備', icon: <BellRing size={18} />, relatedSystems: ['alarm', 'gas_leak'] },
    { id: 'alarm_manual', name: '手動報警機', unit: '組', price: 50, category: '警報設備', icon: <BellRing size={18} />, relatedSystems: ['alarm'] },
    { id: 'broadcast_host', name: '緊急廣播主機', unit: '台', price: 3000, category: '警報設備', icon: <BellRing size={18} />, relatedSystems: ['broadcast'] },
    { id: 'broadcast_speaker', name: '廣播揚聲器', unit: '顆', price: 80, category: '警報設備', icon: <BellRing size={18} />, relatedSystems: ['broadcast'] },
    { id: '119_device', name: '119火災通報裝置', unit: '台', price: 500, category: '警報設備', icon: <BellRing size={18} />, relatedSystems: ['119_notify'] },

    // 3. 避難逃生設備
    { id: 'light_exit', name: '標示設備 (出口/方向)', unit: '具', price: 10, category: '避難逃生設備', icon: <DoorOpen size={18} />, relatedSystems: ['sign'] },
    { id: 'light_emergency', name: '緊急照明設備', unit: '具', price: 10, category: '避難逃生設備', icon: <DoorOpen size={18} />, relatedSystems: ['emergency_light'] },
    { id: 'escape_device', name: '避難器具 (緩降機等)', unit: '具', price: 100, category: '避難逃生設備', icon: <DoorOpen size={18} />, relatedSystems: ['escape'] },

    // 4. 消防搶救上之必要設備
    { id: 'pump_group', name: '消防幫浦組', unit: '組', price: 2000, category: '消防搶救上之必要設備', icon: <Wrench size={18} />, relatedSystems: ['indoor_hydrant', 'outdoor_hydrant', 'sprinkler', 'water_mist', 'foam', 'cooling_sprinkler', 'water_cannon'] },
    { id: 'generator', name: '緊急發電機', unit: '台', price: 2000, category: '消防搶救上之必要設備', icon: <Wrench size={18} />, relatedSystems: ['emergency_power'] },
    { id: 'smoke_damper', name: '排煙閘門', unit: '個', price: 250, category: '消防搶救上之必要設備', icon: <Wrench size={18} />, relatedSystems: ['smoke_exhaust'] },
    { id: 'water_connection', name: '送水口', unit: '支', price: 300, category: '消防搶救上之必要設備', icon: <Wrench size={18} />, relatedSystems: ['water_connection'] },
  ];

  // 根據勾選的系統過濾出需要顯示的設備
  const filteredEquipmentList = equipmentList.filter(item => 
    item.relatedSystems.some(systemId => selectedSystems.includes(systemId))
  );

  // 依類別分組
  const groupedEquipment = filteredEquipmentList.reduce((acc, item) => {
    if (!acc[item.category]) acc[item.category] = [];
    acc[item.category].push(item);
    return acc;
  }, {});

  const categoryOrder = ['滅火設備', '警報設備', '避難逃生設備', '消防搶救上之必要設備'];

  // --- 邏輯處理 ---
  const toggleSystem = (id) => {
    setSelectedSystems(prev => {
      if (prev.includes(id)) {
        return prev.filter(s => s !== id);
      } else {
        return [...prev, id];
      }
    });
  };
  
  const handleInputChange = (id, value) => {
    if (value === '') {
      setQuantities(prev => ({ ...prev, [id]: '' }));
      return;
    }
    const qty = parseInt(value);
    if (!isNaN(qty) && qty >= 0) {
      setQuantities(prev => ({ ...prev, [id]: qty }));
    }
  };

  const handleQuantityChange = (id, delta) => {
    setQuantities(prev => {
      const currentQty = parseInt(prev[id]) || 0;
      const newQty = Math.max(0, currentQty + delta);
      return { ...prev, [id]: newQty };
    });
  };

  const handleUsageChange = (e) => {
    const value = e.target.value;
    if (!value) {
      setSelectedCategory('');
      setSelectedUsage('');
      return;
    }
    const [catId, usageName] = value.split('|');
    setSelectedCategory(catId);
    setSelectedUsage(usageName);
  };

  // 費用計算 Effect
  useEffect(() => {
    let filingFee = 0;
    let inspectionFee = 0;
    let otherFee = 0;

    // 1. 計算申報費
    if (selectedCategory) {
      const place = placeStandards.find(p => p.id === selectedCategory);
      const base =
